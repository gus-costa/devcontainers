# Squid Proxy Configuration for Devcontainer Network Isolation
# See: specs/squid-proxy.md
#
# Purpose: Network traffic filtering for AI agent isolation. All devcontainer
# traffic routes through this proxy, which allows only whitelisted domains.
#
# Adding new domains:
#   1. Add ACL line: acl whitelisted_domains dstdomain .example.com
#   2. Restart: docker compose -f squid/docker-compose.yml restart

# =============================================================================
# Network ACLs
# =============================================================================

# Allow Docker internal networks
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

# Standard ports
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443

# =============================================================================
# Domain Whitelist
# See: specs/squid-proxy.md#domain-whitelist-categories
# =============================================================================

# GitHub - repository access, releases, raw content
acl whitelisted_domains dstdomain .github.com
acl whitelisted_domains dstdomain .githubusercontent.com

# npm - Node.js package registry
acl whitelisted_domains dstdomain registry.npmjs.org

# Python/uv - Python package index
acl whitelisted_domains dstdomain .pypi.org
acl whitelisted_domains dstdomain .pythonhosted.org

# Claude - Anthropic API and telemetry
acl whitelisted_domains dstdomain api.anthropic.com
acl whitelisted_domains dstdomain sentry.io
acl whitelisted_domains dstdomain statsig.anthropic.com
acl whitelisted_domains dstdomain statsig.com
acl whitelisted_domains dstdomain platform.claude.com

# VS Code - extensions and marketplace
acl whitelisted_domains dstdomain main.vscode-cdn.net
acl whitelisted_domains dstdomain .vscode-unpkg.net
acl whitelisted_domains dstdomain marketplace.visualstudio.com
acl whitelisted_domains dstdomain .gallery.vsassets.io
acl whitelisted_domains dstdomain .gallerycdn.vsassets.io

# Qwen
acl whitelisted_domains dstdomain .qwen.ai

# Gemini
acl whitelisted_domains dstdomain oauth2.googleapis.com
acl whitelisted_domains dstdomain cloudcode-pa.googleapis.com

# Others
acl whitelisted_domains dstdomain www.schemastore.org


# =============================================================================
# Access Rules
# Rule order: Allow localnet + whitelisted domains, deny all else
# =============================================================================

# Deny non-safe ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow localnet access to whitelisted domains only
http_access allow localnet whitelisted_domains

# Deny everything else
http_access deny all

# =============================================================================
# Privacy Settings
# See: specs/squid-proxy.md#privacy-settings
# =============================================================================

# Don't add Via header - prevents proxy detection
via off

# Don't expose client IP in X-Forwarded-For
forwarded_for off

# =============================================================================
# Logging
# =============================================================================

# Custom format with full URL, timestamps, status codes
logformat combined %>a %ui %un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh

# Log to /var/log/squid/access.log
access_log daemon:/var/log/squid/access.log combined

# =============================================================================
# Cache Settings
# =============================================================================

# Cache directory - persistent via Docker volume
cache_dir ufs /var/spool/squid 100 16 256

# Listen on port 3128
http_port 3128
